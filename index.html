<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | Marble Race Ultimate</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
      html,body{height:100%;margin:0;overflow:hidden;background:#000;}
      
      #unity-container,#unity-canvas{
        width:100%!important;
        height:100%!important;
        touch-action:none;
        overscroll-behavior:none;
        
        display:block;
        -webkit-touch-callout:none;
        -webkit-user-select:none;
        user-select:none;
      }
      </style>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <!-- <canvas id="unity-canvas" tabindex="-1"></canvas> -->
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Marble Race Ultimate</div>
      </div>
    </div>

    <script type="module">
      /* ---- 1.  import SDK ---- */
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
      window.sdk = sdk;
      
      /* ---- 2.  Unity config FIRST ---- */
      const buildUrl = 'Build';
      const config = {
        dataUrl:      buildUrl + '/race.data',
        frameworkUrl: buildUrl + '/race.framework.js',
        codeUrl:      buildUrl + '/race.wasm',
        streamingAssetsUrl:'StreamingAssets',
        companyName:  'bluzaq',
        productName:  'Marble Race',
        productVersion:'1',
        matchWebGLToCanvasSize:true,
        showBanner:   unityShowBanner        // you already defined this function
      };
      
      /* ---- 3.  Mobile viewport + DPR ---- */
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
        const meta = document.createElement('meta');
        meta.name='viewport';
        meta.content='width=device-width,height=device-height,initial-scale=1,shrink-to-fit=no,user-scalable=no';
        document.head.appendChild(meta);
        config.devicePixelRatio = 1;
      }
      
      /* ---- 4.  Load Unity once DOM is ready ---- */
      const loader = document.createElement('script');
      loader.src = buildUrl + '/race.loader.js';
      loader.onload = () => {
        /* grab DOM nodes ONLY after they exist */
        const canvas   = document.getElementById('unity-canvas');
        const barFull  = document.getElementById('unity-progress-bar-full');
        const loadBar  = document.getElementById('unity-loading-bar');
        const fsButton = document.getElementById('unity-fullscreen-button');
      
        canvas.style.background = `url('${buildUrl}/race.jpg') center / cover`;
        loadBar.style.display = 'block';
      
        createUnityInstance(canvas, config, p => barFull.style.width = 100*p + '%')
          .then(unity => {
            loadBar.style.display = 'none';
            fsButton.onclick = () => unity.SetFullscreen(1);
            return sdk.actions.ready();          // hide Farcaster splash
          })
          .catch(err => {
            console.error('Unity init error', err);
            unityShowBanner('Failed to initialize: ' + err, 'error');
          });
      };
      document.body.appendChild(loader);
      
      /* ---- 5.  Payment bridge (unchanged) ---- */
      window.ChargeForRace = async (tokenId, amount, recipient) => {
        try{
          const res = await sdk.actions.sendToken({ token:tokenId, amount, recipientAddress:recipient });
          SendMessage('FarcasterBridge','OnChargeComplete',JSON.stringify(res));
        }catch(e){
          SendMessage('FarcasterBridge','OnChargeComplete',
                      JSON.stringify({ success:false, error:e.message }));
        }
      };
      </script>      
  </body>
</html>