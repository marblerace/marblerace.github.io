<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | Marble Race</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
      html,body{height:100%;margin:0;overflow:hidden;background:#000;}
      #unity-container, #unity-canvas{
        width:100%!important;
        height:100%!important;
        max-width:100%;
        max-height:100%;
        display:block;
      }
      #tap-capture{
        position:absolute;
        inset:0;                    /* top:0 left:0 right:0 bottom:0 */
        z-index:9999;               /* above canvas */
        background:transparent;
        touch-action:none;          /* don’t scroll the page */
      }
    </style>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <!-- <canvas id="unity-canvas" width="1242" height="2688" tabindex="-1"></canvas> -->
      <!-- <canvas id="unity-canvas" tabindex="-1"></canvas> -->
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Marble Race</div>
      </div>
      <div id="tap-capture"></div>
    </div>

    <script type="module">
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
      window.sdk = sdk;
      
      /* ---------- constants ---------- */
      const buildUrl = "Build";
      const canvas   = document.getElementById("unity-canvas");
      const loadingBar      = document.getElementById("unity-loading-bar");
      const progressBarFull = document.getElementById("unity-progress-bar-full");
      const fullscreenBtn   = document.getElementById("unity-fullscreen-button");
      const warningBanner   = document.getElementById("unity-warning");
      const isMobile        = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      /* ---------- Unity config ---------- */
      const config = {
        dataUrl:      buildUrl + "/race.data",
        frameworkUrl: buildUrl + "/race.framework.js",
        codeUrl:      buildUrl + "/race.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName:  "bluzaq",
        productName:  "Marble Race",
        productVersion:"1",
        matchWebGLToCanvasSize: true,
        showBanner:   unityShowBanner
      };
      
      /* mobile-specific settings AFTER config exists */
      if (isMobile) {
        const meta = document.createElement('meta');
        meta.name   = 'viewport';
        meta.content= 'width=device-width,height=device-height,initial-scale=1,shrink-to-fit=no,user-scalable=no';
        document.head.appendChild(meta);
      
        config.devicePixelRatio = 1;      // keep input in CSS pixels
        canvas.className        = "unity-mobile";
      }
      
      /* ---------- loader ---------- */
      const loaderScript = document.createElement("script");      /* ← was missing */
      loaderScript.src = buildUrl + "/race.loader.js";
      
      let unityInstance = null;
      
      loaderScript.onload = () => {
        createUnityInstance(canvas, config, p => {
          progressBarFull.style.width = 100 * p + '%';
        })
        .then(inst => {
          unityInstance = inst;
          loadingBar.style.display = "none";
          fullscreenBtn.onclick = () => inst.SetFullscreen(1);    // blue ▢ button
          return sdk.actions.ready();                             // hide splash
        })
        .then(() => {
          /* capture first tap on mobile */
          const tapDiv = document.getElementById("tap-capture");
          tapDiv.addEventListener('pointerdown', () => {
            if (unityInstance) unityInstance.SetFullscreen(1);    // now allowed
            tapDiv.remove();
          }, { once:true });
        })
        .catch(err => {
          console.error("Init error", err);
          unityShowBanner("Failed to initialize: "+err, "error");
        });
      };
      
      loaderScript.onerror = () => console.error("Failed to load Unity loader script");
      document.body.appendChild(loaderScript);
      
      /* ---------- helpers ---------- */
      function unityShowBanner(msg, type){
        const div=document.createElement('div');
        div.innerHTML=msg;
        warningBanner.appendChild(div);
        if(type==='error') div.style='background:red;padding:10px';
        else if(type==='warning'){
          div.style='background:yellow;padding:10px';
          setTimeout(()=>div.remove(),5000);
        }
      }
      </script>      
  </body>
</html>